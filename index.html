<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VulnBoard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VulnBoard</h1>
            <p>Vulnerable Message Board System</p>
        </div>

        <div class="nav" id="nav-menu">
            <!-- Dynamic Menu -->
        </div>

        <div id="welcome-msg" class="form-group"></div>

        <button onclick="window.location.href='new-thread.html'" style="margin-bottom: 20px;">新規スレッド作成</button>

        <table class="thread-list">
            <thead>
                <tr>
                    <th style="width: 50%;">タイトル</th>
                    <th style="width: 20%;">作成者</th>
                    <th style="width: 30%;">作成日時</th>
                </tr>
            </thead>
            <tbody id="thread-table-body">
                <!-- Threads will be rendered here -->
            </tbody>
        </table>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/store.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check Login Status & Render Menu
        const currentUser = Auth.getCurrentUser();
        const navDiv = document.getElementById('nav-menu');
        if (currentUser) {
            document.getElementById('welcome-msg').innerText = `ようこそ、${currentUser.username} さん`;
            let navHtml = '<a href="index.html">ホーム</a>';
            navHtml += '<a href="profile.html">プロフィール</a>';
            if (currentUser.isAdmin) {
                navHtml += '<a href="admin.html" style="color:red;">管理画面</a>';
            }
            navHtml += '<a href="#" onclick="Auth.logout()">ログアウト</a>';
            // VULNERABILITY: innerHTML usage
            navDiv.innerHTML = navHtml; 
        } else {
            navDiv.innerHTML = `
                <a href="index.html">ホーム</a>
                <a href="login.html">ログイン</a>
                <a href="register.html">ユーザー登録</a>
            `;
        }

        // Render Threads
        const threads = Store.getThreads();
        const tbody = document.getElementById('thread-table-body');
        
        threads.forEach(thread => {
            const tr = document.createElement('tr');
            
            // VULNERABILITY: Displaying content with innerHTML allows XSS
            // Specifically in the title which links to thread.html
            const titleHtml = `<a href="thread.html?id=${thread.threadId}">${thread.title}</a>`;
            
            tr.innerHTML = `
                <td>${titleHtml}</td> 
                <td>${thread.authorName}</td>
                <td>${Utils.formatDate(thread.createdAt)}</td>
            `;
            tbody.appendChild(tr);
        });

        if (threads.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">まだスレッドがありません。</td></tr>';
        }
    </script>
</body>
</html>
