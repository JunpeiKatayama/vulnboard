<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VulnBoard - 検索</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VulnBoard</h1>
            <p>Vulnerable Message Board System</p>
        </div>

        <div class="nav">
            <a href="index.html">ホーム</a>
        </div>

        <h2>スレッド検索</h2>

        <div class="form-group">
            <label for="query">検索ワード:</label>
            <input type="text" id="query" placeholder="タイトル検索...">
        </div>
        
        <div class="form-group">
             <label for="advanced-filter">高度なフィルタ:</label>
             <input type="text" id="advanced-filter" placeholder="例: thread.title.length > 5 (JS条件式)">
             <p style="font-size:0.8em; color:#666;">※ JavaScriptの式でフィルタリングできます</p>
        </div>

        <button onclick="handleSearch()">検索</button>

        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/store.js"></script>
    <script src="js/auth.js"></script>
    <script>
        function handleSearch() {
            const query = document.getElementById('query').value.toLowerCase();
            const filterExpr = document.getElementById('advanced-filter').value;
            const resultsDiv = document.getElementById('results');
            
            let threads = Store.getThreads();
            
            // Basic search
            if (query) {
                threads = threads.filter(t => 
                    t.title.toLowerCase().includes(query) || 
                    t.content.toLowerCase().includes(query)
                );
            }

            // Advanced filter (VULNERABILITY: eval injection)
            if (filterExpr) {
                try {
                    threads = threads.filter(thread => {
                        // VULNERABILITY: Executing user input
                        return eval(filterExpr);
                    });
                } catch (e) {
                    console.error('Filter error', e);
                    resultsDiv.innerHTML = '<p style="color:red">フィルタエラー</p>';
                    return;
                }
            }

            // Render results
            let html = '<h3>検索結果</h3>';
            if (threads.length === 0) {
                html += '<p>見つかりませんでした。</p>';
            } else {
                html += '<ul style="list-style:none; padding:0;">';
                threads.forEach(t => {
                    html += `
                        <li style="border-bottom:1px solid #ccc; padding:5px;">
                            <a href="thread.html?id=${t.threadId}">${t.title}</a> <!-- XSS -->
                            <span style="font-size:0.8em; color:#666;"> by ${t.authorName}</span>
                        </li>`;
                });
                html += '</ul>';
            }
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
